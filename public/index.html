<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Babylon.js SSR Demo</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        const canvas = document.getElementById('renderCanvas');
        const ctx = canvas.getContext('2d');
        const ws = new WebSocket('ws://localhost:3000');

        // 设置画布大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();

        // 处理窗口大小变化
        window.addEventListener('resize', resizeCanvas);

        // 处理WebSocket消息
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'render') {
                // 显示服务端渲染的画面
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = 'data:image/png;base64,' + data.data;
            }
        };

        // 处理用户交互
        let isMouseDown = false;
        let lastX = 0;
        let lastY = 0;

        canvas.addEventListener('mousedown', (event) => {
            isMouseDown = true;
            lastX = event.clientX;
            lastY = event.clientY;
        });

        canvas.addEventListener('mousemove', (event) => {
            if (!isMouseDown) return;

            const deltaX = event.clientX - lastX;
            const deltaY = event.clientY - lastY;

            // 发送交互事件到服务器
            ws.send(JSON.stringify({
                type: 'interaction',
                data: {
                    rotation: {
                        x: deltaY * 0.01,
                        y: deltaX * 0.01,
                        z: 0
                    }
                }
            }));

            lastX = event.clientX;
            lastY = event.clientY;
        });

        canvas.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isMouseDown = false;
        });
    </script>
</body>
</html>